# Schema Import UX Redesign Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Redesign the schema import flow with progressive disclosure and clearer terminology ("From CSV" / "From your app" instead of "importable" / "context columns").

**Architecture:** Create two new components: `SchemaPreview` (progressive disclosure summary) and `ImportConfirmationModal` (confirmation dialog). Replace the current blue banner in `DestinationSelector` with these components.

**Tech Stack:** React, TypeScript, Radix UI primitives (Dialog, Collapsible), existing UI components (Card, Button, Badge)

---

## Task 1: Create SchemaPreview Component

**Files:**
- Create: `admin/src/components/SchemaPreview.tsx`
- Reference: `admin/src/components/ui/collapsible.tsx`
- Reference: `admin/src/components/ui/card.tsx`

**Step 1: Create the component file with types**

```typescript
// admin/src/components/SchemaPreview.tsx
"use client";

import { useState } from "react";
import { ChevronDown, ChevronRight, FileSpreadsheet, Plug, Cog } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible";

export interface ColumnInfo {
  column_name: string;
  data_type: string;
  is_nullable: boolean;
}

export interface SchemaPreviewProps {
  fromCsvColumns: ColumnInfo[];
  fromAppColumns: ColumnInfo[];
  autoGeneratedColumns: ColumnInfo[];
  isImported?: boolean;
}

export function SchemaPreview({
  fromCsvColumns,
  fromAppColumns,
  autoGeneratedColumns,
  isImported = false,
}: SchemaPreviewProps) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [showDeveloperHints, setShowDeveloperHints] = useState(false);

  const totalColumns = fromCsvColumns.length + fromAppColumns.length + autoGeneratedColumns.length;

  if (totalColumns === 0) {
    return null;
  }

  return (
    <div className="rounded-lg border bg-white">
      {/* Level 0: Summary */}
      <div className="p-4">
        <div className="flex items-center gap-2 mb-3">
          {isImported ? (
            <span className="text-green-600 font-medium">✓ Schema imported</span>
          ) : (
            <span className="font-medium text-gray-900">Ready to import schema</span>
          )}
        </div>

        <ul className="space-y-1 text-sm text-gray-600">
          <li className="flex items-center gap-2">
            <FileSpreadsheet className="w-4 h-4 text-blue-500" />
            <span>{fromCsvColumns.length} column{fromCsvColumns.length !== 1 ? 's' : ''} from CSV</span>
          </li>
          <li className="flex items-center gap-2">
            <Plug className="w-4 h-4 text-purple-500" />
            <span>{fromAppColumns.length} column{fromAppColumns.length !== 1 ? 's' : ''} from your app</span>
          </li>
          <li className="flex items-center gap-2">
            <Cog className="w-4 h-4 text-gray-400" />
            <span>{autoGeneratedColumns.length} auto-generated</span>
          </li>
        </ul>

        {/* Level 1: Expand trigger */}
        <Collapsible open={isExpanded} onOpenChange={setIsExpanded}>
          <CollapsibleTrigger className="flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800 mt-3">
            {isExpanded ? (
              <ChevronDown className="w-4 h-4" />
            ) : (
              <ChevronRight className="w-4 h-4" />
            )}
            <span>Preview columns</span>
          </CollapsibleTrigger>

          <CollapsibleContent className="mt-4">
            {/* Column Lists */}
            <div className="grid grid-cols-3 gap-4 text-sm">
              {/* From CSV */}
              <div>
                <div className="font-medium text-gray-700 mb-2 flex items-center gap-1">
                  <FileSpreadsheet className="w-4 h-4 text-blue-500" />
                  From CSV
                </div>
                <ul className="space-y-1">
                  {fromCsvColumns.map((col) => (
                    <li key={col.column_name} className="text-gray-600 font-mono text-xs">
                      {col.column_name}
                    </li>
                  ))}
                  {fromCsvColumns.length === 0 && (
                    <li className="text-gray-400 italic">None</li>
                  )}
                </ul>
              </div>

              {/* From your app */}
              <div>
                <div className="font-medium text-gray-700 mb-2 flex items-center gap-1">
                  <Plug className="w-4 h-4 text-purple-500" />
                  From your app
                </div>
                <ul className="space-y-1">
                  {fromAppColumns.map((col) => (
                    <li key={col.column_name} className="text-gray-600 font-mono text-xs">
                      {col.column_name}
                      {!col.is_nullable && (
                        <Badge variant="outline" className="ml-1 text-[10px] px-1 py-0">
                          required
                        </Badge>
                      )}
                    </li>
                  ))}
                  {fromAppColumns.length === 0 && (
                    <li className="text-gray-400 italic">None</li>
                  )}
                </ul>

                {/* Level 2: Developer hints */}
                {fromAppColumns.length > 0 && (
                  <Collapsible open={showDeveloperHints} onOpenChange={setShowDeveloperHints}>
                    <CollapsibleTrigger className="flex items-center gap-1 text-xs text-purple-600 hover:text-purple-800 mt-2">
                      {showDeveloperHints ? (
                        <ChevronDown className="w-3 h-3" />
                      ) : (
                        <ChevronRight className="w-3 h-3" />
                      )}
                      <span>How to pass this</span>
                    </CollapsibleTrigger>

                    <CollapsibleContent className="mt-2">
                      <div className="bg-gray-900 text-gray-100 p-3 rounded text-xs font-mono overflow-x-auto">
                        <pre>{`<CSVImporter
  context={{
${fromAppColumns.map((col) => `    ${col.column_name}: "..."`).join(",\n")}
  }}
/>`}</pre>
                      </div>
                    </CollapsibleContent>
                  </Collapsible>
                )}
              </div>

              {/* Auto-generated */}
              <div>
                <div className="font-medium text-gray-700 mb-2 flex items-center gap-1">
                  <Cog className="w-4 h-4 text-gray-400" />
                  Auto-generated
                </div>
                <ul className="space-y-1">
                  {autoGeneratedColumns.map((col) => (
                    <li key={col.column_name} className="text-gray-400 font-mono text-xs">
                      {col.column_name}
                    </li>
                  ))}
                  {autoGeneratedColumns.length === 0 && (
                    <li className="text-gray-400 italic">None</li>
                  )}
                </ul>
              </div>
            </div>
          </CollapsibleContent>
        </Collapsible>
      </div>
    </div>
  );
}
```

**Step 2: Verify the component compiles**

Run: `cd /Users/abhishekray/conductor/workspaces/importcsv/manama/admin && npm run typecheck`
Expected: No errors related to SchemaPreview

**Step 3: Commit**

```bash
git add admin/src/components/SchemaPreview.tsx
git commit -m "feat(admin): add SchemaPreview component with progressive disclosure"
```

---

## Task 2: Create ImportConfirmationModal Component

**Files:**
- Create: `admin/src/components/ImportConfirmationModal.tsx`
- Reference: `admin/src/components/ui/dialog.tsx`

**Step 1: Create the modal component**

```typescript
// admin/src/components/ImportConfirmationModal.tsx
"use client";

import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Button } from "@/components/ui/button";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Info } from "lucide-react";

export interface ColumnInfo {
  column_name: string;
  data_type: string;
  is_nullable: boolean;
}

export interface ImportConfirmationModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  tableName: string;
  fromCsvColumns: ColumnInfo[];
  fromAppColumns: ColumnInfo[];
  hasExistingColumns: boolean;
  onConfirm: () => void;
  isLoading?: boolean;
}

export function ImportConfirmationModal({
  open,
  onOpenChange,
  tableName,
  fromCsvColumns,
  fromAppColumns,
  hasExistingColumns,
  onConfirm,
  isLoading = false,
}: ImportConfirmationModalProps) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle>Import schema from "{tableName}"?</DialogTitle>
          <DialogDescription>
            This will set up your importer with the following columns:
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          {/* From CSV section */}
          <div>
            <div className="text-sm font-medium text-gray-700 mb-2">
              From CSV <span className="font-normal text-gray-500">(users will map these)</span>
            </div>
            <ul className="space-y-1">
              {fromCsvColumns.map((col) => (
                <li key={col.column_name} className="text-sm text-gray-600 font-mono">
                  • {col.column_name}
                </li>
              ))}
              {fromCsvColumns.length === 0 && (
                <li className="text-sm text-gray-400 italic">None</li>
              )}
            </ul>
          </div>

          {/* From your app section */}
          <div>
            <div className="text-sm font-medium text-gray-700 mb-2">
              From your app <span className="font-normal text-gray-500">(you'll pass these)</span>
            </div>
            <ul className="space-y-1">
              {fromAppColumns.map((col) => (
                <li key={col.column_name} className="text-sm text-gray-600 font-mono">
                  • {col.column_name}
                  {!col.is_nullable && (
                    <span className="text-orange-600 ml-1">(required)</span>
                  )}
                </li>
              ))}
              {fromAppColumns.length === 0 && (
                <li className="text-sm text-gray-400 italic">None</li>
              )}
            </ul>
          </div>

          {/* Warning for existing columns */}
          {hasExistingColumns && (
            <Alert>
              <Info className="h-4 w-4" />
              <AlertDescription>
                This replaces your current column configuration
              </AlertDescription>
            </Alert>
          )}
        </div>

        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isLoading}
          >
            Cancel
          </Button>
          <Button onClick={onConfirm} disabled={isLoading}>
            {isLoading ? "Importing..." : "Import Schema"}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Step 2: Verify the component compiles**

Run: `cd /Users/abhishekray/conductor/workspaces/importcsv/manama/admin && npm run typecheck`
Expected: No errors related to ImportConfirmationModal

**Step 3: Commit**

```bash
git add admin/src/components/ImportConfirmationModal.tsx
git commit -m "feat(admin): add ImportConfirmationModal component"
```

---

## Task 3: Update DestinationSelector to Use New Components

**Files:**
- Modify: `admin/src/components/DestinationSelector.tsx`

**Step 1: Add imports at top of file (after line 15)**

Add after existing imports around line 15:

```typescript
import { SchemaPreview } from "@/components/SchemaPreview";
import { ImportConfirmationModal } from "@/components/ImportConfirmationModal";
```

**Step 2: Add state for confirmation modal (after line 73)**

Add after the existing state declarations around line 73:

```typescript
const [showImportConfirmation, setShowImportConfirmation] = useState(false);
const [isImported, setIsImported] = useState(false);
```

**Step 3: Create helper to get auto-generated columns (after line 45)**

Add after the `isAutoGeneratedColumn` function around line 45:

```typescript
function getAutoGeneratedColumns(columns: SupabaseColumnSchema[]): SupabaseColumnSchema[] {
  return columns.filter((col) => isAutoGeneratedColumn(col.column_name));
}
```

**Step 4: Create handleImportConfirm function (around line 200, after other handlers)**

```typescript
const handleImportConfirm = () => {
  if (onImportSchema) {
    onImportSchema(value.mappedColumns);
    setIsImported(true);
  }
  setShowImportConfirmation(false);
};
```

**Step 5: Replace the current import schema banner (lines 316-338)**

Replace the entire block from lines 316-338:

```typescript
{value.supabaseColumns.length > 0 && onImportSchema && (
  <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100">
    <div className="text-sm">
      <p className="font-medium text-blue-900">
        {hasExistingColumns
          ? "Replace columns from table schema?"
          : "Import columns from table schema?"}
      </p>
      <p className="text-blue-700">
        {value.mappedColumns.length} importable columns, {value.contextColumns.length} context columns detected
      </p>
    </div>
    <Button
      type="button"
      size="sm"
      onClick={() => onImportSchema(value.mappedColumns)}
    >
      <Download className="w-4 h-4 mr-2" />
      Import Schema
    </Button>
  </div>
)}
```

With this new block:

```typescript
{value.supabaseColumns.length > 0 && onImportSchema && (
  <div className="space-y-3">
    <SchemaPreview
      fromCsvColumns={value.mappedColumns}
      fromAppColumns={value.contextColumns.map((c) => ({
        column_name: c.columnName,
        data_type: c.dataType,
        is_nullable: c.isNullable,
      }))}
      autoGeneratedColumns={getAutoGeneratedColumns(value.supabaseColumns)}
      isImported={isImported}
    />

    <div className="flex justify-end">
      <Button
        type="button"
        size="sm"
        onClick={() => setShowImportConfirmation(true)}
      >
        <Download className="w-4 h-4 mr-2" />
        {isImported ? "Re-import Schema" : "Import Schema"}
      </Button>
    </div>

    <ImportConfirmationModal
      open={showImportConfirmation}
      onOpenChange={setShowImportConfirmation}
      tableName={value.tableName || ""}
      fromCsvColumns={value.mappedColumns}
      fromAppColumns={value.contextColumns.map((c) => ({
        column_name: c.columnName,
        data_type: c.dataType,
        is_nullable: c.isNullable,
      }))}
      hasExistingColumns={hasExistingColumns || false}
      onConfirm={handleImportConfirm}
    />

    {isImported && (
      <div className="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border">
        Next: Configure column mapping in the <strong>Columns</strong> tab
      </div>
    )}
  </div>
)}
```

**Step 6: Reset isImported when table changes**

In the `handleTableSelect` function (around line 123), add at the end of the function before the closing brace:

```typescript
setIsImported(false);
```

**Step 7: Verify the component compiles**

Run: `cd /Users/abhishekray/conductor/workspaces/importcsv/manama/admin && npm run typecheck`
Expected: No errors

**Step 8: Commit**

```bash
git add admin/src/components/DestinationSelector.tsx
git commit -m "feat(admin): integrate SchemaPreview and ImportConfirmationModal

Replace the old import schema banner with:
- Progressive disclosure via SchemaPreview
- Confirmation modal before import
- Updated terminology (From CSV / From your app)
- Post-import state with next step hint"
```

---

## Task 4: Visual Testing

**Files:**
- None (manual testing)

**Step 1: Start the admin dev server**

Run: `cd /Users/abhishekray/conductor/workspaces/importcsv/manama && docker-compose up -d`
Expected: All services start successfully

**Step 2: Navigate to importer creation page**

Open: `http://localhost:3000/importers/new`

**Step 3: Test the flow**

1. Select a Supabase integration
2. Select a table with multiple columns
3. Verify the summary shows correct counts
4. Click "Preview columns" and verify columns display in 3 groups
5. Click "How to pass this" and verify code snippet appears
6. Click "Import Schema" button
7. Verify confirmation modal appears with correct columns listed
8. Click "Import Schema" in modal
9. Verify:
   - Summary changes to "✓ Schema imported"
   - Button changes to "Re-import Schema"
   - Next step hint appears

**Step 4: Document any issues**

If issues found, note them for follow-up fixes.

---

## Task 5: Run Linting and Build

**Files:**
- None (verification)

**Step 1: Run lint**

Run: `cd /Users/abhishekray/conductor/workspaces/importcsv/manama/admin && npm run lint`
Expected: No errors (warnings acceptable)

**Step 2: Run build**

Run: `cd /Users/abhishekray/conductor/workspaces/importcsv/manama/admin && npm run build`
Expected: Build succeeds

**Step 3: Fix any issues**

If lint or build fails, fix issues and commit fixes.

**Step 4: Final commit if needed**

```bash
git add -A
git commit -m "fix(admin): address lint/build issues"
```

---

## Summary

| Task | Description | Files |
|------|-------------|-------|
| 1 | Create SchemaPreview component | `SchemaPreview.tsx` |
| 2 | Create ImportConfirmationModal | `ImportConfirmationModal.tsx` |
| 3 | Integrate into DestinationSelector | `DestinationSelector.tsx` |
| 4 | Visual testing | Manual |
| 5 | Lint and build verification | None |

**Total commits:** 3-4
**Estimated complexity:** Low-medium (UI changes only, no backend)
